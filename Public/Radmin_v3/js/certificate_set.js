var loading=false;$(function(){var b=[];var a='{"bgImg": "/Public/Home/images/certificate/certificate.jpg",';$.ajax({url:modelDate,async:false,success:function(c){if(c.code==1){$.each(c.info,function(d,e){a+='"'+d+'":{"open":"'+e[1]+'","example":"'+e[0]+'","str":"'+e[2]+'","x":"'+e[3]+'","y":"'+e[4]+'","fillStyle":"'+e[5]+'","font":"'+e[6]+'","order":"'+e[7]+'","hide":"'+e[8]+'"},'});a=a.substr(0,a.length-1)+"}";a=JSON.parse(a);if(cavConfig==""){cavConfig=a}$.each(cavConfig,function(g,i){if(g=="bgImg"){return}var e=i.font.split(/ |,/);var h=e[1].replace(/px/g,"");var d=e[0];var f="";if(g=="company"){f='<div class="layui-form-item items"><label class="form-text">'+i.example+'：</label><div class="form-right" data-belog="'+g+'">'+'<div class="special_wrapper"><input type="text" name="'+g+'" class="layui-input special" placeholder="输入'+i.example+'" value="'+i.str+'"/></div>'}else{f='<div class="layui-form-item items"><label class="form-text">'+i.example+'：</label><div class="form-right" data-belog="'+g+'">'+'<div class="switch_wrapper"><input type="checkbox" name="close" lay-skin="switch" lay-text="ON|OFF" '+(i.open=="1"?"checked":"")+"></div>"}f+='<div class="around_wrapper">'+'<div class="layui-input-inline" style="width: 60px;"><input type="number" name="xaxis" placeholder="X轴" autocomplete="off" class="layui-input xaxis" value="'+i.x+'"'+(i.open=="0"?"disabled":"")+" >"+'</div><div class="layui-form-mid">-</div><div class="layui-input-inline" style="width: 60px;">'+'<input type="number" name="yaxis" placeholder="Y轴" autocomplete="off" class="layui-input yaxis" value="'+i.y+'" '+(i.open=="0"?"disabled":"")+'></div></div><div class="color_wrapper">'+'<input type="color" name="color_select" class="color_select" value="'+i.fillStyle+'" '+(i.open=="0"?"disabled":"")+'/><div class="layui-input-inline">'+'<input type="text" name="color_text" class="color_text layui-input" placeholder="输入或选择字体颜色" value="'+i.fillStyle+'" '+(i.open=="0"?"disabled":"")+"/></div>"+'<input type="number" name="font_size" class="font_size layui-input" value="'+h+'" placeholder="字体大小" '+(i.open=="0"?"disabled":"")+"/>"+'<i class="fa fa-bold '+(i.open=="1"?"font_weight ":" ")+(d=="bold"?"active":"")+' font_weights" data-weight="'+d+'"></i></div><div class="hide_wrapper layui-input-inline">'+'<input type="checkbox" name="hide" title="隐藏文字" '+(i.hide=="1"?"checked":" ")+(i.open=="0"?"disabled ":" ")+' data-str="'+i.str+'"></div></div></div>';b.push(f);if(i.hide==1){cavConfig[g].str=hideText(i.str)}})}else{console.log(c.msg)}}});$("#certificate_img").before(b);form.render();$(".layui-upload-img").load(function(){draw(cavConfig)});$(".certificate—submit").bind("click",function(){$.post(upload_config,{cavconfig:JSON.stringify(cavConfig)},function(c){layer.msg(c.msg);setTimeout(function(){window.location.reload();},2000)})});form.on("checkbox",function(d){var c=$(this).parent().parent(".form-right").data("belog");if(d.elem.checked){cavConfig[c].hide=1;var e=cavConfig[c].str;$(this).attr("data-str",e);cavConfig[c].str=hideText(e)}else{cavConfig[c].hide=0;cavConfig[c].str=$(this).data("str")}draw(cavConfig)});form.on("switch",function(d){var c=$(this).parent().parent(".form-right").data("belog");if(d.elem.checked){cavConfig[c]["open"]=1;$(this).parent().parent().find(".font_weights").addClass("font_weight");$(this).parent().parent().find("input").prop("disabled",false);$(this).parent().parent().find(".hide_wrapper input").prop("disabled",false);$(".font_weight").bind("click",function(){toggleBold(this)})}else{cavConfig[c]["open"]=0;$(this).parent().parent().find("input").prop("disabled",true);$(this).parent().parent().find("input[type=checkbox]").prop("disabled",false);$(this).parent().parent().find(".hide_wrapper input").prop("disabled",true);$(this).parent().parent().find(".font_weights").removeClass("font_weight")}form.render();draw(cavConfig)});$(".xaxis").bind("input propertychange change",function(d){var c=$(this).parent().parent().parent(".form-right").data("belog");if($(this).val()==""||$(this).val()<0){cavConfig[c]["x"]=0}else{cavConfig[c]["x"]=$(this).val()}draw(cavConfig)});$(".yaxis").bind("input propertychange change",function(d){var c=$(this).parent().parent().parent(".form-right").data("belog");if($(this).val()==""||$(this).val()<0){cavConfig[c]["y"]=0}else{cavConfig[c]["y"]=$(this).val()}draw(cavConfig)});$(".color_text").bind("input propertychange change",function(d){var c=$(this).parent().parent().parent(".form-right").data("belog");$(this).parent().siblings(".color_select").val($(this).val());if($(this).val()==""||!new RegExp(/^[#]/).test($(this).val())||$(this).val().length!=7){cavConfig[c]["fillStyle"]="#000000"}else{cavConfig[c]["fillStyle"]=$(this).val()}draw(cavConfig)});$(".color_select").bind("input propertychange change",function(d){var c=$(this).parent().parent(".form-right").data("belog");$(this).siblings(".layui-input-inline").children(".color_text").val($(this).val());cavConfig[c]["fillStyle"]=$(this).val();draw(cavConfig)});$(".font_size").bind("input propertychange change",function(e){var d=$(this).parent().parent(".form-right").data("belog");var c=cavConfig[d]["font"].split(/ |,/);if($(this).val()!=""){c[1]=c[1].replace(/^[0-9]*/g,$(this).val())}else{c[1]="0px"}cavConfig[d]["font"]=c.toString().replace(/,/g," ");draw(cavConfig)});$(".font_weight").bind("click",function(){toggleBold(this)});$(document).on("input propertychange",".special",function(){var c=$(this).parent().parent(".form-right").data("belog");cavConfig[c].str=$(this).val();draw(cavConfig)})});function draw(c){if(loading){return}else{loading=true}var b=document.getElementById("mycanvas");var a=b.getContext("2d");b.width=b.width;b.height=b.height;a.clearRect(0,0,b.width,b.height);a.drawImage($(".layui-upload-img")[0],0,0,652,920);a.save();$.each(c,function(d,e){if(d=="bgImg"||e["open"]!=1){return}a.fillStyle=e["fillStyle"];a.font=e["font"];a.fillText(e["str"],e["x"],e["y"]);a.restore()});loading=false;$("#mycanvas").bind("mousedown touchstart",function(k){var f="";var j=b.getBoundingClientRect();var i=(k.clientX-j.left)*b.width/j.width;var h=(k.clientY-j.top)*b.height/j.height;$.each(c,function(s,r){if(s=="bgImg"){return}var o=r["font"].match(/\d+/g)[0];var p=r["font"].match(/\d+/g)[0];var n=new RegExp(/[0-9]/,"g");var m=new RegExp(/[a-z]/,"g");var l=r["str"].match(n);var e=r["str"].match(m);var q=!l?0:l.length;q=!e?q:q+e.length;if(s=="agentLevel"){}if((r["open"]=="1")&&(i>parseInt(r["x"])&&i<(parseInt(r["x"])+p*(r["str"].length)-(p*q/2)))&&(h<r["y"]&&h>(r["y"]-o))){var t="";$.each(c,function(w,u){if(w=="bgImg"){return}if(u["open"]==1&&t==""){t=w;return}});if(r["order"]>=cavConfig[t]["order"]){f=s}}});var g=cavConfig[f]["x"];var d=cavConfig[f]["y"];$("#mycanvas").bind("mousemove touchmove",function(o){if(f==""){return}var l=b.getBoundingClientRect();var q=(o.clientX-l.left)*b.width/l.width;var n=(o.clientY-l.top)*b.height/l.height;var p=parseInt(g)+parseInt(q-i);var m=parseInt(d)+parseInt(n-h);if(Math.abs(p-parseInt(cavConfig[f]["x"]))>2||Math.abs(m-parseInt(cavConfig[f]["y"]))>2){cavConfig[f]["x"]=p;cavConfig[f]["y"]=m;$(".items div[data-belog="+f+"]").find(".xaxis").val(p);$(".items div[data-belog="+f+"]").find(".yaxis").val(m);draw(cavConfig)}});$("#mycanvas").bind("mouseup touchend",function(l){$(this).off("mousemove touchmove")})})}function upload_done(a){cavConfig.bgImg=a;$(".layui-upload-img").load(function(){draw(cavConfig)})}function toggleBold(d){var b=$(d).toggleClass("active").parent().parent(".form-right").data("belog");var c="";if($(d).attr("data-weight")=="normal"){$(d).attr("data-weight","bold")}else{$(d).attr("data-weight","normal")}c=$(d).attr("data-weight");var a=cavConfig[b]["font"].split(/ |,/);a[0]=c;cavConfig[b]["font"]=a.toString().replace(/,/g," ");draw(cavConfig)}function hideText(a){var b="";$.ajax({url:hide_text,data:{txt:a},async:false,success:function(c){b=c}});return b};